{% extends 'base_dev.html' %}
{% load static %}
{% load devpanel_filters %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent p-0 m-0">
                <li class="breadcrumb-item"><a href="{% url 'dev_gestion_secciones' %}">Secciones</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ pagina.get_slug_display }}</li>
            </ol>
        </nav>
        <h1 class="h3 mb-1 text-gray-800">{{ pagina.titulo }}</h1>
        <p class="mb-0 text-muted">Gestiona las secciones de esta p√°gina</p>
    </div>
    <div>
        <button class="btn btn-success" data-toggle="modal" data-target="#modalNuevaSeccion">
            <i class="fas fa-plus"></i> Nueva Secci√≥n
        </button>
    </div>
</div>

<!-- Lista de Secciones -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-layer-group"></i> Secciones de la p√°gina ({{ secciones.count }})
        </h6>
    </div>
    <div class="card-body">
        {% if secciones %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="thead-light">
                    <tr>
                        <th width="5%">Orden</th>
                        <th width="15%">Tipo</th>
                        <th width="30%">T√≠tulo/Identificador</th>
                        <th width="10%" class="text-center">Estado</th>
                        <th width="20%">√öltima Actualizaci√≥n</th>
                        <th width="20%" class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for seccion in secciones %}
                    <tr>
                        <td class="align-middle">
                            <span class="badge badge-secondary" style="font-size: 14px;">{{ seccion.orden }}</span>
                        </td>
                        <td class="align-middle">
                            {% if seccion.tipo == 'hero' or seccion.tipo == 'carousel' %}
                                <span class="badge badge-primary">
                                    <i class="fas fa-image"></i> {{ seccion.get_tipo_display }}
                                </span>
                            {% elif seccion.tipo == 'texto' %}
                                <span class="badge badge-info">
                                    <i class="fas fa-align-left"></i> {{ seccion.get_tipo_display }}
                                </span>
                            {% elif seccion.tipo == 'features' %}
                                <span class="badge badge-success">
                                    <i class="fas fa-th"></i> {{ seccion.get_tipo_display }}
                                </span>
                            {% elif seccion.tipo == 'testimonios' %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-star"></i> {{ seccion.get_tipo_display }}
                                </span>
                            {% elif seccion.tipo == 'cta' %}
                                <span class="badge badge-danger">
                                    <i class="fas fa-bullhorn"></i> {{ seccion.get_tipo_display }}
                                </span>
                            {% else %}
                                <span class="badge badge-secondary">
                                    {{ seccion.get_tipo_display }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="align-middle">
                            <strong>{{ seccion.titulo|default:"Sin t√≠tulo" }}</strong>
                            {% if seccion.configuracion.titulo %}
                                <br><small class="text-muted">{{ seccion.configuracion.titulo|truncatewords:8 }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center align-middle">
                            {% if seccion.activa %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle"></i> Activa
                                </span>
                            {% else %}
                                <span class="badge badge-secondary">
                                    <i class="fas fa-times-circle"></i> Inactiva
                                </span>
                            {% endif %}
                        </td>
                        <td class="align-middle">
                            <small class="text-muted">
                                {{ seccion.actualizado_en|date:"d/m/Y H:i" }}
                            </small>
                        </td>
                        <td class="text-center align-middle">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#modalVerSeccion{{ seccion.id }}" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modalEditarSeccion{{ seccion.id }}" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="{% url 'dev_cambiar_orden_seccion' seccion.id 'subir' %}" class="btn btn-sm btn-secondary" title="Subir">
                                    <i class="fas fa-arrow-up"></i>
                                </a>
                                <a href="{% url 'dev_cambiar_orden_seccion' seccion.id 'bajar' %}" class="btn btn-sm btn-secondary" title="Bajar">
                                    <i class="fas fa-arrow-down"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#modalEliminarSeccion{{ seccion.id }}" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle"></i> Esta p√°gina no tiene secciones configuradas a√∫n.
        </div>
        {% endif %}
    </div>
</div>

<!-- Modales de Vista Previa -->
{% for seccion in secciones %}
<div class="modal fade" id="modalVerSeccion{{ seccion.id }}" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye"></i> Vista Previa: {{ seccion.titulo|default:"Secci√≥n" }}
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6 class="text-primary">Tipo de Secci√≥n:</h6>
                <p>{{ seccion.get_tipo_display }}</p>

                <h6 class="text-primary mt-3">Configuraci√≥n:</h6>
                <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">{{ seccion.configuracion|pprint }}</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal: Nueva Secci√≥n -->
<div class="modal fade" id="modalNuevaSeccion" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="POST" action="{% url 'dev_crear_seccion' pagina.slug %}">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i> Crear Nueva Secci√≥n
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="tipo">Tipo de Secci√≥n *</label>
                        <select name="tipo" id="tipo" class="form-control" required>
                            <option value="">-- Selecciona un tipo --</option>
                            <option value="hero">üé¨ Hero (Banner Principal)</option>
                            <option value="carousel">üé† Carrusel de Im√°genes</option>
                            <option value="texto">üìù Bloque de Texto</option>
                            <option value="features">üéØ Caracter√≠sticas/Beneficios</option>
                            <option value="testimonios">‚≠ê Testimonios/Reconocimientos</option>
                            <option value="cta">üì¢ Call to Action</option>
                            <option value="galeria">üñºÔ∏è Galer√≠a de Im√°genes</option>
                            <option value="mapa">üó∫Ô∏è Mapa</option>
                        </select>
                        <small class="form-text text-muted">Elige el tipo de contenido que quieres mostrar</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="titulo">T√≠tulo Identificador (opcional)</label>
                        <input type="text" name="titulo" id="titulo" class="form-control" placeholder="Ej: Banner principal, Servicios destacados...">
                        <small class="form-text text-muted">Para identificar f√°cilmente esta secci√≥n en el panel</small>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" name="activa" id="activa" class="form-check-input" checked>
                        <label class="form-check-label" for="activa">
                            Activar secci√≥n (se mostrar√° en el sitio web)
                        </label>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i> <strong>Nota:</strong> Despu√©s de crear la secci√≥n, podr√°s editar su contenido espec√≠fico (textos, im√°genes, etc.).
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Crear Secci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modales de Edici√≥n -->
{% for seccion in secciones %}
<div class="modal fade" id="modalEditarSeccion{{ seccion.id }}" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="POST" action="{% url 'dev_editar_seccion' seccion.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> Editar: {{ seccion.titulo|default:seccion.get_tipo_display }}
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#info{{ seccion.id }}">Info B√°sica</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#config{{ seccion.id }}">Configuraci√≥n JSON</a>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <div id="info{{ seccion.id }}" class="tab-pane fade show active">
                            <div class="form-group">
                                <label>Tipo de Secci√≥n</label>
                                <select name="tipo" class="form-control">
                                    <option value="hero" {% if seccion.tipo == 'hero' %}selected{% endif %}>üé¨ Hero (Banner Principal)</option>
                                    <option value="carousel" {% if seccion.tipo == 'carousel' %}selected{% endif %}>üé† Carrusel de Im√°genes</option>
                                    <option value="texto" {% if seccion.tipo == 'texto' %}selected{% endif %}>üìù Bloque de Texto</option>
                                    <option value="features" {% if seccion.tipo == 'features' %}selected{% endif %}>üéØ Caracter√≠sticas/Beneficios</option>
                                    <option value="testimonios" {% if seccion.tipo == 'testimonios' %}selected{% endif %}>‚≠ê Testimonios/Reconocimientos</option>
                                    <option value="cta" {% if seccion.tipo == 'cta' %}selected{% endif %}>üì¢ Call to Action</option>
                                    <option value="galeria" {% if seccion.tipo == 'galeria' %}selected{% endif %}>üñºÔ∏è Galer√≠a de Im√°genes</option>
                                    <option value="mapa" {% if seccion.tipo == 'mapa' %}selected{% endif %}>üó∫Ô∏è Mapa</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>T√≠tulo Identificador</label>
                                <input type="text" name="titulo" class="form-control" value="{{ seccion.titulo }}">
                            </div>
                            
                            <div class="form-check">
                                <input type="checkbox" name="activa" class="form-check-input" {% if seccion.activa %}checked{% endif %}>
                                <label class="form-check-label">Secci√≥n activa</label>
                            </div>
                        </div>
                        
                        <div id="config{{ seccion.id }}" class="tab-pane fade">
                            <div class="form-group">
                                <label>Configuraci√≥n JSON</label>
                                <textarea name="configuracion_json" class="form-control" rows="15" style="font-family: monospace;">{{ seccion.configuracion|pprint }}</textarea>
                                <small class="form-text text-muted">Edita cuidadosamente el JSON. Aseg√∫rate de que la sintaxis sea v√°lida.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminarSeccion{{ seccion.id }}" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="POST" action="{% url 'dev_eliminar_seccion' seccion.id %}">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-trash"></i> Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas eliminar la secci√≥n <strong>{{ seccion.titulo|default:seccion.get_tipo_display }}</strong>?</p>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Advertencia:</strong> Esta acci√≥n no se puede deshacer. El contenido de esta secci√≥n se perder√° permanentemente.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Eliminar Secci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

