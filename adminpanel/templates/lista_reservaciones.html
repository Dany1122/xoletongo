{% extends 'base_admin.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h3 text-gray-800 mb-0">Reservaciones</h2>
  <div class="btn-group" role="group" aria-label="Acciones de reservaciones">
    {# Ejemplos opcionales #}
    <a href="{% url 'admin_exportar_reservas_pdf' %}" class="btn btn-outline-danger">
      <i class="fas fa-file-pdf"></i> Exportar PDF
    </a> 
    <a href="{% url 'admin_reservaciones' %}" class="btn btn-outline-secondary">
      <i class="fas fa-sync"></i> Actualizar
    </a>
  </div>
</div>

{% if reservaciones %}
  <div class="row">
    {% for item in reservaciones %}
      {% with reservacion=item.reservacion servicio=item.servicio tipo=item.tipo_servicio titulo=item.titulo_servicio total=item.total_pagado pago_realizado=item.pago_realizado %}
      <div class="col-xl-6 col-lg-6 col-md-12 mb-4">
        <div class="reservation-card card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="mr-2">
                <h5 class="mb-1 text-truncate" title="{{ titulo|default:'Servicio' }}">
                  <i class="fas fa-clipboard-list mr-1 text-primary"></i>
                  {{ titulo|default:"Servicio" }}
                </h5>
                <div class="small text-muted">
                  <i class="fas fa-user mr-1"></i>
                  {{ reservacion.nombre_cliente|default:"Cliente" }}
                  &middot;
                  <i class="fas fa-envelope mr-1"></i>
                  {{ reservacion.email_cliente|default:"sin-correo@ejemplo.com" }}
                </div>
              </div>

              <div class="text-right">
                {# Badge de pago #}
                {% if pago_realizado %}
                  <span class="badge badge-success" title="Pago registrado">
                    <i class="fas fa-check-circle"></i> Pagado
                  </span>
                {% else %}
                  <span class="badge badge-warning" title="Pago pendiente">
                    <i class="fas fa-exclamation-circle"></i> Pendiente
                  </span>
                {% endif %}
                <div class="mt-2">
                  {% if reservacion.get_estado_display %}
                    {% with estado=reservacion.estado %}
                        {% if estado == 'pendiente' or estado == 'nuevo' or estado == 'creada' %}
                            <span class="badge badge-info">{{ reservacion.get_estado_display }}</span>
                        {% elif estado == 'confirmada' or estado == 'aprobada' or estado == 'completada' %}
                            <span class="badge badge-primary">{{ reservacion.get_estado_display }}</span>
                        {% elif estado == 'cancelada' or estado == 'rechazada' %}
                            <span class="badge badge-secondary">{{ reservacion.get_estado_display }}</span>
                        {% else %}
                            <span class="badge badge-light">{{ reservacion.get_estado_display }}</span>
                        {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="badge badge-light">Sin estado</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <hr class="my-3">

            <div class="row">
              <div class="col-sm-7">
                {% if tipo == "porHora" %}
                  <div class="mb-2">
                    <span class="text-muted small d-block">Fecha / hora</span>
                    <strong>
                      <i class="far fa-clock mr-1"></i>
                      {{ reservacion.fecha_reserva|date:"d/m/Y H:i" }}
                    </strong>
                  </div>
                {% elif tipo == "porDia" %}
                  <div class="mb-2">
                    <span class="text-muted small d-block">Rango de fechas</span>
                    <strong>
                      <i class="far fa-calendar-alt mr-1"></i>
                      {{ reservacion.fecha_inicio|date:"d/m/Y" }} &rarr; {{ reservacion.fecha_fin|date:"d/m/Y" }}
                    </strong>
                  </div>
                {% else %}
                  <div class="mb-2">
                    <span class="text-muted small d-block">Tipo de servicio</span>
                    <em>No especificado</em>
                  </div>
                {% endif %}

                <div class="mb-2">
                  <span class="text-muted small d-block">Total pagado</span>
                  <strong class="h5 mb-0">
                    ${{ total|default:0|floatformat:2|intcomma }}
                  </strong>
                </div>

                {% if not pago_realizado and reservacion.comprobante_pago %}
                  <div class="mt-2">
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      data-toggle="modal"
                      data-target="#comprobanteModal"
                      data-url="{{ reservacion.comprobante_pago.url }}"
                      data-nombre="{{ reservacion.nombre_cliente|default:'Cliente' }}">
                      <i class="far fa-file-alt"></i> Ver comprobante
                    </button>
                  </div>
                {% endif %}
              </div>

              <div class="col-sm-5">
                <form method="post" action="" class="mt-3 mt-sm-0">
                  {% csrf_token %}
                  <input type="hidden" name="reservacion_id" value="{{ reservacion.id }}">
                  <label for="estado-{{ reservacion.id }}" class="small text-muted d-block mb-1">Actualizar estado</label>
                  <div class="d-flex align-items-center">
                    <select id="estado-{{ reservacion.id }}" name="estado" class="form-control form-control-sm mr-2">
                      {% for clave, texto in reservacion.ESTADOS %}
                        <option value="{{ clave }}" {% if reservacion.estado == clave %}selected{% endif %}>
                          {{ texto }}
                        </option>
                      {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm">
                      <i class="fas fa-save"></i> Guardar
                    </button>
                  </div>
                </form>
              </div>
            </div>

          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div class="small text-muted">
              <i class="far fa-hashtag mr-1"></i>ID: {{ reservacion.id }}
            </div>
            <div class="small text-muted">
              <i class="far fa-clock mr-1"></i>
              Actualizado: {{ reservacion.updated_at|default:reservacion.fecha_reserva|date:"d/m/Y H:i" }}
            </div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-light border text-muted" role="alert">
    No hay reservaciones.
  </div>
{% endif %}

{# Modal global para mostrar comprobante (imagen/PDF en iframe) #}
<div class="modal fade" id="comprobanteModal" tabindex="-1" role="dialog" aria-labelledby="comprobanteLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="comprobanteLabel">
          <i class="far fa-file-alt mr-1"></i> Comprobante de pago
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body p-0">
        <div class="embed-responsive embed-responsive-16by9">
          <iframe id="comprobanteFrame" class="embed-responsive-item" src="" title="Comprobante" loading="lazy"></iframe>
        </div>
      </div>
      <div class="modal-footer">
        <a id="comprobanteLink" href="#" target="_blank" rel="noopener" class="btn btn-outline-secondary">
          <i class="fas fa-external-link-alt"></i> Abrir en pestaña
        </a>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Tarjeta con estética limpia como la de productos */
.reservation-card{
  border:1px solid #e6e1f0;
  border-radius:1rem;
  transition:transform .2s ease, box-shadow .2s ease;
}
.reservation-card:hover{
  transform:translateY(-4px);
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}
.text-truncate{max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
@media (max-width:575.98px){.text-truncate{max-width:280px}}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Modal de comprobante: asigna URL al iframe y al botón "Abrir en pestaña"
  $('#comprobanteModal').on('show.bs.modal', function (event) {
    var btn = $(event.relatedTarget);
    var url = btn.data('url') || '';
    var modal = $(this);
    modal.find('#comprobanteFrame').attr('src', url);
    modal.find('#comprobanteLink').attr('href', url);
  });

  // Limpia iframe al cerrar para evitar reproducir contenido/retener memoria
  $('#comprobanteModal').on('hidden.bs.modal', function () {
    $(this).find('#comprobanteFrame').attr('src', '');
  });
});
</script>

{% endblock %}